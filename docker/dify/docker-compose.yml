version: '3.8'

services:
  # PostgreSQL database
  db:
    image: postgres:15-alpine
    restart: always
    environment:
      PGUSER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      POSTGRES_DB: dify
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - db_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD', 'pg_isready']
      interval: 1s
      timeout: 3s
      retries: 30

  # Redis cache
  redis:
    image: redis:6-alpine
    restart: always
    volumes:
      - redis_data:/data
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme}
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']

  # Weaviate vector database
  weaviate:
    image: semitechnologies/weaviate:1.19.0
    restart: always
    volumes:
      - weaviate_data:/var/lib/weaviate
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'false'
      PERSISTENCE_DATA_PATH: /var/lib/weaviate
      DEFAULT_VECTORIZER_MODULE: none
      CLUSTER_HOSTNAME: 'node1'
      AUTHENTICATION_APIKEY_ENABLED: 'true'
      AUTHENTICATION_APIKEY_ALLOWED_KEYS: ${WEAVIATE_API_KEY:-changeme}
      AUTHENTICATION_APIKEY_USERS: 'hello@dify.ai'
      AUTHORIZATION_ADMINLIST_ENABLED: 'true'
      AUTHORIZATION_ADMINLIST_USERS: 'hello@dify.ai'

  # Dify API service
  api:
    image: langgenius/dify-api:0.15.3
    restart: always
    environment:
      # Mode
      MODE: api
      LOG_LEVEL: INFO

      # Database
      DB_USERNAME: postgres
      DB_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: dify

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      REDIS_USE_SSL: 'false'
      REDIS_DB: 0

      # Celery
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/1
      BROKER_USE_SSL: 'false'

      # Vector DB
      VECTOR_STORE: weaviate
      WEAVIATE_ENDPOINT: http://weaviate:8081
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY:-changeme}

      # Storage (local)
      STORAGE_TYPE: local
      STORAGE_LOCAL_PATH: storage

      # Security
      SECRET_KEY: ${DIFY_SECRET_KEY:-changeme}

      # CORS
      WEB_API_CORS_ALLOW_ORIGINS: '*'
      CONSOLE_CORS_ALLOW_ORIGINS: '*'

      # File upload
      UPLOAD_FILE_SIZE_LIMIT: 15
      UPLOAD_FILE_BATCH_LIMIT: 5

      # App URL
      CONSOLE_API_URL: ''
      CONSOLE_WEB_URL: ''
      SERVICE_API_URL: ''
      APP_WEB_URL: ''
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - api_storage:/app/api/storage

  # Dify worker service
  worker:
    image: langgenius/dify-api:0.15.3
    restart: always
    environment:
      # Mode
      MODE: worker
      LOG_LEVEL: INFO

      # Database
      DB_USERNAME: postgres
      DB_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
      DB_HOST: db
      DB_PORT: 5432
      DB_DATABASE: dify

      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-changeme}
      REDIS_USE_SSL: 'false'
      REDIS_DB: 0

      # Celery
      CELERY_BROKER_URL: redis://:${REDIS_PASSWORD:-changeme}@redis:6379/1
      BROKER_USE_SSL: 'false'

      # Vector DB
      VECTOR_STORE: weaviate
      WEAVIATE_ENDPOINT: http://weaviate:8081
      WEAVIATE_API_KEY: ${WEAVIATE_API_KEY:-changeme}

      # Storage (local)
      STORAGE_TYPE: local
      STORAGE_LOCAL_PATH: storage

      # Security
      SECRET_KEY: ${DIFY_SECRET_KEY:-changeme}
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - api_storage:/app/api/storage

  # Dify web frontend
  web:
    image: langgenius/dify-web:0.15.3
    restart: always
    environment:
      CONSOLE_API_URL: http://localhost:3001
      APP_API_URL: http://localhost:3001
      SENTRY_DSN: ''

  # Nginx reverse proxy
  nginx:
    image: nginx:latest
    restart: always
    ports:
      - "3001:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api
      - web

volumes:
  db_data:
  redis_data:
  weaviate_data:
  api_storage:
